package main

import (
	"ai_jianli_go/pkg/rag"
	"context"
	"os"
	"testing"

	"github.com/cloudwego/eino/components/document"
)

func TestXxx(t *testing.T) {
	logFile, err := os.OpenFile("./log.txt", os.O_CREATE|os.O_WRONLY|os.O_APPEND, 0644)
	if err != nil {
		panic(err)
	}
	defer logFile.Close()

	// log := func(format string, args ...interface{}) {
	// 	fmt.Fprintf(logFile, format+"\n", args...)
	// }

	ctx := context.Background()
	rag.Init()
	// è·å–æ–‡æ¡£
	docs, err := rag.GetLoader().Load(ctx, document.Source{
		URI: "./test1.pdf",
	})
	if err != nil {
		t.Error("æ–‡æ¡£è§£æå¤±è´¥ï¼š", err)
		return
	}

	// å­˜å‚¨
	indexer := rag.GetIndexer()
	_, err = indexer.Store(ctx, docs)

	if err != nil {
		t.Error(err)
	}

	// 	// æ£€ç´¢
	// 	retriever := component.GetRetriever()

	// 	// å¯¹è¯æ¨¡å‹
	// 	chatModel, err := openai.NewChatModel(ctx, &openai.ChatModelConfig{
	// 		Model:   "gpt-4o",
	// 		BaseURL: "https://api.vveai.com/v1",
	// 		APIKey:  "sk-Xs5rROO2htFLGMJh407b42F505Fe4c89A8510f7608E52c2f",
	// 	})
	// 	if err != nil {
	// 		panic(err)
	// 	}

	// 	// è®°å¿†
	// 	memory := component.NewRedisMemory(component.RedisMemoryConfig{
	// 		MaxWindowSize: 20,
	// 		RedisOptions: &redis.Options{
	// 			Addr:     "124.222.151.35:6379",
	// 			Password: "123456",
	// 		},
	// 	})

	// 	con := memory.GetConversation("1", true)
	// 	con.SetLastConversationKnowledge("java")
	// 	fmt.Println("å¼€å§‹é¢è¯•")
	// 	for {
	// 		docs, err := retriever.Retrieve(ctx, con.GetLastConversationsKnowledge())
	// 		if err != nil {
	// 			fmt.Println("æ–‡æ¡£æ£€ç´¢å¤±è´¥ï¼š", err)
	// 			return
	// 		}

	// 		// æ¨¡å‹é—®ç­”
	// 		context := ""
	// 		// æŸ¥çœ‹æ–‡æ¡£å†…å®¹
	// 		if len(docs) > 0 {
	// 			contextParts := make([]string, len(docs))
	// 			for i, doc := range docs {
	// 				contextParts[i] = fmt.Sprintf("æ–‡æ¡£ç‰‡æ®µ[%d]:\n%s\n", i+1, doc.Content)
	// 			}
	// 			context = strings.Join(contextParts, "\n---\n")
	// 		}

	// 		// åˆ›å»ºæ¨¡æ¿ï¼Œä½¿ç”¨ FString æ ¼å¼
	// 		template := prompt.FromMessages(schema.FString,
	// 			// ç³»ç»Ÿè§’è‰²å®šä¹‰ + æ ¸å¿ƒä»»åŠ¡è¯´æ˜ + è¾“å‡ºæ ¼å¼è¦æ±‚
	// 			schema.SystemMessage(
	// 				"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šé¢è¯•å®˜ï¼Œéœ€è¦å®Œæˆä»¥ä¸‹ä»»åŠ¡ï¼š\n"+
	// 					"1. åŸºäºä¸“ä¸šçŸ¥è¯†åº“å†…å®¹æå‡ºç²¾å‡†é—®é¢˜\n"+
	// 					"2. å¯¹ç”¨æˆ·å›ç­”è¿›è¡Œç»“æ„åŒ–è¯„ä»·ï¼ˆä¼˜ç‚¹/ä¸è¶³ï¼‰\n"+
	// 					"3. é’ˆå¯¹ä¸è¶³ç‚¹ç»™å‡ºä¸“ä¸šè§£é‡Š\n"+
	// 					"4. æ ¹æ®ç”¨æˆ·å›ç­”ç”Ÿæˆ1-4è½®æ·±åº¦è¿½é—®ï¼Œ è¿½é—®ç»“æŸç»§ç»­æ ¹æ®ç®€å†å†…å®¹æé—®\n"+
	// 					"5. æ¯æ¬¡å›ç­”éƒ½éœ€è¦è¿”å›è¦é—®çš„çŸ¥è¯†ç‚¹ï¼ˆå…³é”®è¯ï¼‰ä»¥ä¾¿åç»­çŸ¥è¯†åº“æ£€ç´¢æé—®\n\n"+
	// 					"6. è¿½é—®æ¯æ¬¡åªè¿½é—®ä¸€é“é¢˜ç›®ï¼Œ åç»­åœ¨æ ¹æ®ç”¨æˆ·å›ç­”ç»§ç»­è¿½é—®ï¼Œæœ€å¤šè¿½é—®4è½®\n"+
	// 					"å½“å‰çŸ¥è¯†åº“ä¸Šä¸‹æ–‡ï¼š{context}\n\n"+
	// 					"å½“å‰å¯¹è¯è®°å½•ï¼š{history}\n\n"+
	// 					"ç”¨æˆ·ç®€å†å†…å®¹:{resume}\n"+
	// 					"è¾“å‡ºæ ¼å¼è¦æ±‚ï¼š\n"+
	// 					"- è¯„ä»·ä½¿ç”¨âœ…å’ŒâŒæ ‡è¯†ä¼˜åŠ£ç‚¹\n",
	// 			),

	// 			// ç”¨æˆ·å›ç­”æ•è·
	// 			schema.UserMessage("ã€åº”è˜è€…å›ç­”ã€‘\n{answer}"),

	// 			// ç³»ç»Ÿå›ç­”
	// 			schema.AssistantMessage(
	// 				"è¯·æŒ‰ä»¥ä¸‹ç»“æ„ç»„ç»‡å›ç­”ï¼š\n"+
	// 					"1. è¯„ä»·æ€»ç»“ï¼ˆå«å…·ä½“ä¸è¶³ç‚¹åˆ†æï¼‰\n"+
	// 					"2. å¯è¿½é—®çš„çŸ¥è¯†ç‚¹:knowledgepoint",
	// 				[]schema.ToolCall{},
	// 			),
	// 		)

	// 		var prompt map[string]any = make(map[string]any)

	// 		prompt["context"] = context
	// 		answer := ""
	// 		fmt.Scanln(&answer)
	// 		fmt.Println("ğŸ§‘â€ : ", answer)
	// 		log("ç”¨æˆ·è¾“å…¥: %s", answer)
	// 		prompt["answer"] = answer
	// 		prompt["resume"] = `
	// 		å¹¿ä¸œçŸ³æ²¹åŒ–å·¥å­¦é™¢ - æœ¬ç§‘ - æ•°æ®ç§‘å­¦ä¸å¤§æ•°æ®æŠ€æœ¯
	// 2022.09 - 2026.06 - å¹¿ä¸œ
	// ç»¼åˆæˆç»©ï¼š ä¸“ä¸šå‰15%ï¼›GPA:3.8/5;CET-4:480
	// <!-- - å¯ä»¥åˆ é™¤ -->
	// è£èª‰å¥–é¡¹ï¼š æ ¡çº§ä¸€ç­‰å¥–å­¦é‡‘ã€è“æ¡¥æ¯çœäºŒ
	// è¯­é›€: https://www.yuque.com/zhongxiashier-qqvas/study
	// Github: https://github.com/zhongxia12
	// å˜‰ä¸ºè“é²¸-å¹¿å·å˜‰ä¸ºç§‘æŠ€æœ‰é™å…¬å¸-åç«¯ç ”å‘å®ä¹ ç”Ÿ
	// ä¸»è¦å·¥ä½œï¼š
	// å¯¹æ¥è…¾è®¯iegä¸‹çš„è‡ªç ”paaså¹³å°è“é²¸ä¸šåŠ¡
	// é€šè¿‡å‘½ä»¤è¡Œå‚æ•°åŠ¨æ€åŒ–ï¼ˆé…ç½®è§£æ + å‚æ•°å®æ—¶æ³¨å…¥ï¼‰ï¼Œè§£å†³äº†é™æ€å‚æ•°å¯¼è‡´çš„èµ„æºåˆ©ç”¨ç‡ç“¶é¢ˆï¼Œå°† CPU åˆ©ç”¨ç‡ä»
	// 60% æå‡è‡³ 85%ï¼Œä»»åŠ¡ååé‡æå‡ 45%ã€‚
	// é’ˆå¯¹å¤šç§ä¸»ä»æ•°æ®å¤„ç†ï¼Œé€šè¿‡åˆ†æ­¥æŸ¥è¯¢ + æ˜ å°„ç¼“å­˜ä¼˜åŒ–ï¼Œç»“åˆç­–ç•¥ä¸å·¥å‚æ¨¡å¼è§£è€¦å¤šæ¨¡æ¿é€»è¾‘ï¼Œå°†æ•°æ®åº“äº¤äº’æ—¶é—´
	// å¤æ‚åº¦ä» O(n) ä¼˜åŒ–ä¸º O(1)ï¼ŒæŸ¥è¯¢è€—æ—¶é™ä½ 64%ã€‚
	// é‡‡ç”¨ AI é©±åŠ¨çš„å¤šæ¨¡å—åˆ†æ + é»‘ç™½ç›’æµ‹è¯•æ–¹æ³•ï¼Œç¼–å†™æµ‹è¯•ç”¨ä¾‹ï¼Œè¯†åˆ«å‡ºå¤§é‡è¾¹ç•Œæ¡ä»¶å’Œå¼‚å¸¸åœºæ™¯ï¼Œå°†æµ‹è¯•è¦†ç›–ç‡ä»
	// 58% æå‡è‡³ 83%ï¼Œæ¼æµ‹ç¼ºé™·å‡å°‘ 75%ã€‚
	// é€šè¿‡ DDD åŸºç¡€è®¾æ–½å±‚é‡æ„ ï¼Œå®ç°å…¬å…±ç»„ä»¶ç»Ÿä¸€ç®¡ç†ï¼Œå»ºè®¾é˜²è…å±‚éš”ç¦»ä¸šåŠ¡ä¾èµ–ï¼Œé‡‡ç”¨ç°åº¦è¿ç§»ç­–ç•¥ï¼Œæ¶ˆé™¤ä»£ç å†—
	// ä½™ï¼Œå°†å˜æ›´æˆæœ¬é™ä½ 80%ï¼Œæ–°åŠŸèƒ½æ¥å…¥æ•ˆç‡æå‡ 50%ã€‚
	// è®¾è®¡é¡¹ç›®ç¼“å­˜æ¶æ„,å¹¶å®ç°äº†MySQL-Redis-æœ¬åœ°å†…å­˜ä¸‰çº§ç¼“å­˜ä½“ç³»ï¼Œå°†æ ¸å¿ƒæ¥å£å“åº”æ—¶é—´ä»200msé™è‡³30msã€‚
	// ğŸ°ç§¯åˆ†æŠ½å¥–è¥é”€æ¿€åŠ±ç³»ç»Ÿ 2024.07 - 2024.10
	// æŠ€æœ¯æ ˆ: ã€ ã€ ã€ ã€ ã€ ã€ ã€ ã€
	// é¡¹ç›®æè¿°: å‚è€ƒæ˜é‡‘ç¤¾åŒºçš„ç­¾åˆ°æŠ½å¥–å’Œæ‹¼å¤šå¤šå¤§è½¬ç›˜å¼€å‘çš„æŠ½å¥–ç³»ç»Ÿã€‚æ»¡è¶³Cç«¯äººç¾¤æ‹‰æ–°ã€ä¿ƒæ´»ã€ç•™å­˜ç­‰éœ€æ±‚ï¼›æ”¯æŒç­¾
	// åˆ°è¿”åˆ©ã€ç§¯åˆ†å…‘æ¢ã€ç´¯è®¡è§£é”ç­‰åŠŸèƒ½ã€‚ä¸ºæå‡ç³»ç»Ÿæ‰©å±•å’Œå¯ç»´æŠ¤æ€§ï¼Œé‡‡ç”¨å¤šç§è®¾è®¡æ¨¡å¼ã€‚åŒæ—¶é’ˆå¯¹æ€§ä¼˜åŒ–äº†æŠ½å¥–ç®—æ³•
	// å’Œç§’æ€åœºæ™¯ï¼Œå¯æ”¯æŒå•æœº4c16gæœåŠ¡å™¨500~800TPS,æŠ½å¥–æ¥å£å“åº”æ—¶é•¿45~100msã€‚
	// æŠ€æœ¯äº®ç‚¹:
	// ç³»ç»Ÿæ¶æ„: é‡‡ç”¨DDDé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼Œä¸šåŠ¡æ‹†åˆ†ä¸ºç­–ç•¥é¢†åŸŸ(å¥–å“ç­–ç•¥)ã€è´£ä»»é¢†åŸŸ(å‚ä¸æŠ½å¥–)ã€å¥–å“é¢†åŸŸ(å‘æ”¾å¥–å“)ã€
	// ä»»åŠ¡é¢†åŸŸ(æ¶ˆæ¯å‘é€)ï¼Œå¹¶ä½¿ç”¨å¤šç§è®¾è®¡æ¨¡å¼ï¼Œå¦‚ï¼šç»„åˆæ¨¡å¼ã€å·¥å‚æ¨¡å¼ã€è´£ä»»é“¾æ¨¡å¼å’Œæ¨¡æ¿æ¨¡å¼ï¼›
	// æµç¨‹è®¾è®¡: ä½¿ç”¨æ¨¡æ¿æ¨¡å¼å®šä¹‰æŠ½å¥–ã€æŠ½å¥–ä¸­ä¸æŠ½å¥–åå„é˜¶æ®µæµç¨‹ï¼›æŠ½å¥–å‰è¿›è¡Œè®¢å•åˆ›å»ºå’Œå‚æ•°æ ¡éªŒï¼›æŠ½å¥–ä¸­ä½¿ç”¨å·¥
	// å‚æ¨¡å¼ç»„è£…è´£ä»»é“¾ï¼Œè¿›è¡Œé»‘ / ç™½åå•å’Œæƒé‡è¿‡æ»¤ï¼›æŠ½å¥–ååˆ©ç”¨ç»„åˆæ¨¡å¼æ„é€ å†³ç­–æ ‘æ¨¡å‹åšè§£é”ã€åº“å­˜å’Œå…œåº•å¥–å“çš„
	// è¿›ä¸€æ­¥è¿‡æ»¤ï¼Œæ”¯æŒå·®å¼‚åŒ–è¥é”€æ´»åŠ¨ã€‚
	// æ•°æ®åº“è·¯ç”±: ä½¿ç”¨è‡ªç ”ç»„ä»¶DBRouterï¼ŒåŸºäºå“ˆå¸Œæ•£åˆ—å’Œæ–æ³¢é‚£å¥‘æ‰°ä¹±ç®—æ³•ï¼Œä¾æ®ç”¨æˆ· ID å¯¹æŠ½å¥–è®¢å•ã€ä¸­å¥–è®¢å•ç­‰
	// é«˜é¢‘ç‡è¿›è¡Œåˆ†åº“åˆ†è¡¨å®ç°ã€‚é€šè¿‡CanalåŒæ­¥ Binlog æ—¥å¿—è‡³Elasticsearchï¼Œæ”¯æŒé«˜æ•ˆèšåˆæŸ¥è¯¢ã€‚
	// æ¥å£å¯ç”¨æ€§: é€šè¿‡AOPç¼–ç¨‹å’Œè‡ªå®šä¹‰æ³¨è§£ç»“åˆRedissionä»¤ç‰Œæ¡¶å®ç°åŠ¨æ€è¶…é¢‘æ¬¡è®¿é—®é™æµï¼Œå¼•å…¥Hystrixæä¾›æœåŠ¡ç†”
	// æ–­èƒ½åŠ›ï¼›åˆ©ç”¨Zookeeperå®ç°åˆ†å¸ƒå¼åŠ¨æ€é…ç½®é™çº§ã€é™æµã€è¶…æ—¶ç†”æ–­å¼€å…³ç»„ä»¶ï¼Œæé«˜ç³»ç»Ÿçµæ´»æ€§ã€‚
	// é«˜å¹¶å‘å¤„ç†: ä½¿ç”¨Redis decråº“å­˜æ‰£å‡ï¼Œå¹¶å€Ÿé‰´ConcurrentHashMapçš„åˆ†æ®µé”æœºåˆ¶ï¼Œè®¾è®¡éç‹¬å ç«äº‰çš„åˆ†æ®µåŒ–å…œ
	// åº•é˜²è¶…å–ï¼Œé€šè¿‡å»¶è¿Ÿé˜Ÿåˆ—+å®šæ—¶ä»»åŠ¡å¼‚æ­¥å¤„ç†ä¿è¯æ•°æ®æœ€ç»ˆä¸€è‡´æ€§ï¼Œç¼“è§£æ•°æ®åº“å¹¶å‘å‹åŠ›ã€‚
	// åç»­åŠ ä¸€ä¸ªspring ai
	// Javaï¼šç†Ÿç»ƒæŒæ¡JavaåŸºç¡€çŸ¥è¯†ï¼Œç†Ÿæ‚‰å¸¸ç”¨é›†åˆã€Streamæµã€Lambdaè¡¨è¾¾å¼çš„ä½¿ç”¨ï¼Œäº†è§£Java 8æ–°ç‰¹æ€§ã€‚
	// MySQLï¼šç†Ÿæ‚‰æŒæ¡MySQLï¼Œç†è§£äº‹åŠ¡ã€ç´¢å¼•ã€æ—¥å¿—ã€é”æœºåˆ¶ã€MVCCç­‰ï¼Œå…·å¤‡ä¸€å®šSQLè°ƒä¼˜èƒ½åŠ›ã€‚
	// Redisï¼šç†Ÿæ‚‰æŒæ¡Redisï¼Œç†è§£å¸¸è§æ•°æ®ç»“æ„ã€æŒä¹…åŒ–æœºåˆ¶ã€å†…å­˜æ·˜æ±°ã€å“¨å…µæœºåˆ¶ï¼Œç¼“å­˜æ•…éšœç­‰ã€‚
	// JUCï¼šç†Ÿæ‚‰Javaå¹¶å‘å®¹å™¨çš„ä½¿ç”¨åŠåŸç†ï¼Œå¯¹çº¿ç¨‹æ± ã€é‡å…¥é”ã€AQSã€volatileå…³é”®å­—æœ‰ä¸€å®šäº†è§£ã€‚
	// JVMï¼šç†Ÿæ‚‰ç±»åŠ è½½æœºåˆ¶ã€JVMçš„å†…å­˜åŒºåŸŸã€åƒåœ¾å›æ”¶å™¨ç­‰ï¼›äº†è§£å†…å­˜æº¢å‡ºã€å†…å­˜æ³„æ¼ç­‰é—®é¢˜ã€‚
	// æ¶ˆæ¯é˜Ÿåˆ—ï¼šç†Ÿæ‚‰RabbitMQçš„ä½¿ç”¨ï¼Œç†è§£ä¸€è‡´æ€§ã€ä¸é‡å¤æ¶ˆè´¹ã€é¡ºåºæ¶ˆè´¹ã€å»¶è¿Ÿæ¶ˆè´¹ã€æ¶ˆæ¯å †ç§¯ç­‰é—®é¢˜ã€‚
	// æ¡†æ¶ï¼šç†Ÿç»ƒä½¿ç”¨SSMã€Spring Bootã€Spring Cloudç­‰æ¡†æ¶ï¼Œç†è§£IOCã€AOPã€Beanç”Ÿå‘½å‘¨æœŸç­‰ã€‚
	// è®¾è®¡æ¨¡å¼ï¼šç†Ÿæ‚‰ä½¿ç”¨å¸¸è§çš„è®¾è®¡æ¨¡å¼ï¼Œå¦‚ï¼šè´£ä»»é“¾ã€ç­–ç•¥ã€æ¨¡æ¿ã€å·¥å‚ç­‰æ¨¡å¼ï¼Œæé«˜ä»£ç å¯å¤ç”¨æ€§ã€‚
	// ğŸ“æ•™è‚²èƒŒæ™¯
	// é«˜æ°´å¹³ç†å·¥ç§‘å¤§å­¦ å“è¶Šå·¥ç¨‹å¸ˆåŸ¹å…»è®¡åˆ’
	// ğŸ“‹å®ä¹ ç»å†
	// âœï¸é¡¹ç›®ç»éªŒ
	// DDD SpringBoot Redis MySQL MyBatis RabbitMQ ZooKeeper ES Canal
	// ğŸ¯ä¸“ä¸šæŠ€èƒ½
	// æ¶æ„ï¼šäº†è§£DDDé¢†åŸŸé©±åŠ¨è®¾è®¡ï¼Œå¦‚å……è¡€æ¨¡å‹ã€ä¾èµ–å€’ç½®ã€å››è‰²å»ºæ¨¡ç­‰ï¼Œäº†è§£DDDåˆ†å±‚æ¶æ„ã€å…­è¾¹å½¢æ¶æ„ç­‰ã€‚
	// å…¶å®ƒï¼šç†Ÿç»ƒä½¿ç”¨Mavenã€Gitã€Dockerç­‰å¼€å‘ç®¡ç†å·¥å…·ï¼Œæœ‰Prometheus + Grafanaç›‘æ§ç³»ç»Ÿéƒ¨ç½²ç»éªŒã€‚

	// 		`
	// 		prompt["history"] = con.String()
	// 		// ä½¿ç”¨æ¨¡æ¿ç”Ÿæˆæ¶ˆæ¯
	// 		messages, err := template.Format(ctx, prompt)
	// 		if err != nil {
	// 			fmt.Println(err)
	// 			return
	// 		}
	// 		log("", messages)
	// 		con.Append(schema.UserMessage(fmt.Sprintln(answer)))
	// 		res, err := chatModel.Generate(ctx, messages)
	// 		if err != nil {
	// 			fmt.Println(err)
	// 			return
	// 		}
	// 		fmt.Println(extractKnowledgePoint(res.Content))
	// 		con.SetLastConversationKnowledge(extractKnowledgePoint(res.Content))
	// 		con.Append(res)

	// 		fmt.Println("ğŸ¤– : ", res.Content)

	// 	}

	// }

	// func extractKnowledgePoint(input string) string {
	// 	// æŸ¥æ‰¾"å¯è¿½é—®çš„çŸ¥è¯†ç‚¹ï¼š"çš„ä½ç½®
	// 	prefix := "å¯è¿½é—®çš„çŸ¥è¯†ç‚¹ï¼š"
	// 	index := strings.Index(input, prefix)

	// 	if index >= 0 {
	// 		// æå–å‰ç¼€ä¹‹åçš„æ‰€æœ‰å†…å®¹
	// 		result := input[index+len(prefix):]
	// 		// å»é™¤å¼€å¤´å¯èƒ½çš„å¤šä½™ç©ºæ ¼
	// 		return strings.TrimSpace(result)
	// 	}

	// 	// å…¼å®¹å¯èƒ½ä½¿ç”¨è‹±æ–‡å†’å·çš„æƒ…å†µ
	// 	prefix = "å¯è¿½é—®çš„çŸ¥è¯†ç‚¹:"
	// 	index = strings.Index(input, prefix)
	// 	if index >= 0 {
	// 		result := input[index+len(prefix):]
	// 		return strings.TrimSpace(result)
	// 	}

	//		return "" // æœªæ‰¾åˆ°åŒ¹é…
	//	}
}
